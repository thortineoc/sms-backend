DROP TABLE IF EXISTS grades;
DROP TABLE IF EXISTS parent_child;
DROP TABLE IF EXISTS Answers;
DROP TABLE IF EXISTS class_student;
DROP TABLE IF EXISTS Presences;
DROP TABLE IF EXISTS Homeworks;
DROP TABLE IF EXISTS Classes;
DROP TABLE IF EXISTS Subjects;
DROP TABLE IF EXISTS users;
DROP TYPE IF EXISTS presence_type;




CREATE TYPE presence_type AS ENUM (
    'present',
    'absent',
    'late',
    'excused'
    );


CREATE TABLE Users (
                       id 		SERIAL PRIMARY KEY,
                       kc_id 		varchar(80)	NOT NULL,
                       firstName	varchar(31)	NOT NULL,
                       secondName 	varchar(31),
                       surName 	varchar(31)	NOT NULL
);

CREATE TABLE Subjects (
                          id 		SERIAL PRIMARY KEY,
                          name 		varchar(63) 	NOT NULL
);

CREATE TABLE Class_Student (
                               class_id int NOT NULL,
                               student_id int NOT NULL
);

CREATE TABLE Classes (
                         id 		SERIAL PRIMARY KEY,
                         subject_id 	int 		NOT NULL,
                         teacher_id 	int		NOT NULL,
                         weekday 	int		NOT NULL,
                         room 		int		NOT NULL,
                         beginDate 	date		NOT NULL,
                         endDate		date		NOT NULL,
                         lesson		int		NOT NULL
);

CREATE TABLE Grades (
                        id 		SERIAL PRIMARY KEY,
                        subject_id 	int 		NOT NULL,
                        student_id 	int 		NOT NULL,
                        grade		int		NOT NULL,
                        description 	TEXT,
                        weight 		int 		DEFAULT 1
);

CREATE TABLE Homeworks (
                           id		SERIAL PRIMARY KEY,
                           title		varchar(255)	NOT NULL,
                           description	TEXT,
                           deadline	timestamp	NOT NULL,
                           file 		bytea,
                        class_id int NOT NULL
);

CREATE TABLE Presences (
                           id		SERIAL PRIMARY KEY,
                           student_id	int		NOT NULL,
                           class_id	int		NOT NULL,
                           day		date		NOT NULL,
                           type		presence_type	DEFAULT 'present'
);

CREATE TABLE Answers (
                         id 		SERIAL PRIMARY KEY,
                         homework_id	int		NOT NULL,
                         student_id	int		NOT NULL,
                         review		TEXT,
                         file		bytea
);

CREATE TABLE Parent_Child (
                              parent_id	int		NOT NULL,
                              child_id	int		NOT NULL
);


ALTER TABLE Grades
    ADD CONSTRAINT fk_grades_student_id
        FOREIGN KEY(student_id)
            REFERENCES Users(id)
            ON DELETE CASCADE;

ALTER TABLE Parent_Child
    ADD CONSTRAINT fk_pc_parent_id
        FOREIGN KEY(parent_id)
            REFERENCES Users(id)
            ON DELETE CASCADE;

ALTER TABLE Parent_Child
    ADD CONSTRAINT fk_pc_child_id
        FOREIGN KEY(child_id)
            REFERENCES Users(id)
            ON DELETE CASCADE;

ALTER TABLE Grades
    ADD CONSTRAINT fk_grades_subject_id
        FOREIGN KEY(subject_id)
            REFERENCES Subjects(id)
            ON DELETE SET NULL;

ALTER TABLE Classes
    ADD CONSTRAINT fk_classes_teacher_id
        FOREIGN KEY(teacher_id)
            REFERENCES Users(id)
            ON DELETE CASCADE;

ALTER TABLE Classes
    ADD CONSTRAINT fk_classes_subject_id
        FOREIGN KEY(subject_id)
            REFERENCES Subjects(id)
            ON DELETE CASCADE;

ALTER TABLE Class_Student
    ADD CONSTRAINT fk_cs_student_id
        FOREIGN KEY(student_id)
            REFERENCES Users(id)
            ON DELETE CASCADE;

ALTER TABLE Class_Student
    ADD CONSTRAINT fk_cs_class_id
        FOREIGN KEY(class_id)
            REFERENCES Classes(id)
            ON DELETE CASCADE;

ALTER TABLE Presences
    ADD CONSTRAINT fk_presences_class_id
        FOREIGN KEY(class_id)
            REFERENCES Classes(id)
            ON DELETE CASCADE;

ALTER TABLE Presences
    ADD CONSTRAINT fk_presences_student_id
        FOREIGN KEY(student_id)
            REFERENCES Users(id)
            ON DELETE CASCADE;

ALTER TABLE Homeworks
    ADD CONSTRAINT fk_homeworks_class_id
        FOREIGN KEY(class_id)
            REFERENCES Classes(id)
            ON DELETE CASCADE;


ALTER TABLE Answers
    ADD CONSTRAINT fk_answers_homework_id
        FOREIGN KEY(homework_id)
            REFERENCES Homeworks(id)
            ON DELETE CASCADE;

ALTER TABLE Answers
    ADD CONSTRAINT fk_answers_student_id
        FOREIGN KEY(student_id)
            REFERENCES Users(id)
            ON DELETE CASCADE;
